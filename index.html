<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Floor Check Log</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; padding: 0; }
    .container { max-width: 500px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    h1 { font-size: 1.6em; margin-bottom: 16px; }
    label { font-weight: bold; display: block; margin-bottom: 8px; }
    input[type="text"] { width: 100%; padding: 8px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;}
    .section-title { margin: 18px 0 8px 0; font-weight: bold; }
    .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;}
    button { 
      padding: 10px 18px; 
      border: none; 
      border-radius: 4px; 
      background: #000; /* Changed to black */
      color: #fff;      /* Changed to white text */
      cursor: pointer; 
      font-size: 1em; 
      transition: background 0.2s;
    }
    button:active { background: #333; } /* Slightly lighter when pressed */
    #log-list { margin-top: 24px; }
    /* Make log bubbles grey */
    .log-entry { background: #e0e0e0; margin-bottom: 8px; padding: 10px; border-radius: 4px; font-size: 0.95em;}
    .timestamp { color: #888; font-size: 0.9em; }
    /* Make export button grey and distinguish from normal buttons */
    .export-btn { 
      background: #888; 
      margin-top: 18px; 
      color: #fff; 
      transition: background 0.2s;
    }
    .export-btn:active { background: #aaa; }
    .no-entries { color: #888; margin-top: 10px; }
  </style>
  <!-- Add jsPDF from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Floor Check Log</h1>
  <label for="team-member">Team Member</label>
  <input type="text" id="team-member" placeholder="Enter your name..." autocomplete="off">

  <div class="section-title">Cinemas</div>
  <div class="button-group" id="cinema-btns"></div>

  <div class="section-title">Bathrooms</div>
  <div class="button-group" id="bathroom-btns"></div>

  <button class="export-btn" id="export-btn">Export Log (PDF)</button>

  <div id="log-list"></div>
</div>

<script>
const cinemas = ['Vmax', 'Screen X', 'Cinema 3', 'Cinema 4', 'Cinema 5', 'Cinema 6', 'Cinema 7', 'Cinema 8'];
const bathrooms = ['Male bathroom', 'Female bathroom', 'Access bathroom'];
const locations = [...cinemas, ...bathrooms];
const logKey = 'floorCheckLog';

function loadLogs() {
  try {
    return JSON.parse(localStorage.getItem(logKey)) || [];
  } catch (e) {
    return [];
  }
}

function saveLogs(logs) {
  localStorage.setItem(logKey, JSON.stringify(logs));
}

function addLogEntry(name, location) {
  const now = new Date();
  // Only keep time in local format (no date)
  const logEntry = {
    name,
    location,
    time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }),
    iso: now.toISOString()
  };
  const logs = loadLogs();
  logs.unshift(logEntry); // newest on top
  saveLogs(logs);
  renderLogs();
}

function getTodayLogs() {
  const logs = loadLogs();
  const todayDate = new Date().toISOString().slice(0, 10);
  return logs.filter(entry => entry.iso.slice(0, 10) === todayDate);
}

// Group logs by location, unique names, times for each name (only time, no date)
function groupLogsForDisplay(logs) {
  const grouped = {};
  locations.forEach(loc => { grouped[loc] = []; });
  logs.forEach(entry => {
    if (grouped[entry.location]) {
      // If name is already listed for this location, push time to their times array
      let person = grouped[entry.location].find(e => e.name === entry.name);
      if (!person) {
        grouped[entry.location].push({ name: entry.name, times: [entry.time] });
      } else {
        person.times.push(entry.time);
      }
    }
  });
  return grouped;
}

function renderLogs() {
  const logs = getTodayLogs();
  const logList = document.getElementById('log-list');
  logList.innerHTML = `<h3>Log for Today</h3>`;
  if (logs.length === 0) {
    logList.innerHTML += '<div class="no-entries">No entries yet.</div>';
    return;
  }

  const grouped = groupLogsForDisplay(logs);
  locations.forEach(loc => {
    const entries = grouped[loc];
    logList.innerHTML += `<div class="log-entry"><strong>${loc}</strong><br>`;
    if (entries.length === 0) {
      logList.innerHTML += '<span class="timestamp">No entries</span>';
    } else {
      entries.forEach(person => {
        logList.innerHTML += `<span>${person.name}`;
        if (person.times.length > 0) {
          logList.innerHTML += `: <span class="timestamp">${person.times.join(', ')}</span>`;
        }
        logList.innerHTML += `</span><br>`;
      });
    }
    logList.innerHTML += `</div>`;
  });
}

function makeButtons(arr, parentId) {
  const parent = document.getElementById(parentId);
  arr.forEach(item => {
    const btn = document.createElement('button');
    btn.textContent = item;
    btn.onclick = () => {
      const name = document.getElementById('team-member').value.trim();
      if (!name) {
        alert('Please enter your name.');
        return;
      }
      addLogEntry(name, item);
    };
    parent.appendChild(btn);
  });
}

// For PDF: group logs by location, only unique names per location, show times for each name, date at top
function exportLogPDF() {
  const logs = getTodayLogs();
  if (logs.length === 0) {
    alert('No log entries to export.');
    return;
  }
  const grouped = groupLogsForDisplay(logs);

  // jsPDF setup
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 16;
  doc.setFontSize(18);
  doc.text('Floor Check Log', 14, y);
  y += 10;
  doc.setFontSize(12);
  doc.text('Date: ' + new Date().toLocaleDateString(), 14, y);
  y += 8;

  locations.forEach(loc => {
    const entries = grouped[loc];
    doc.setFont(undefined, 'bold');
    doc.text(loc, 14, y);
    doc.setFont(undefined, 'normal');
    y += 7;

    if (entries.length === 0) {
      doc.setTextColor(150);
      doc.text('No entries', 18, y);
      doc.setTextColor(0);
      y += 7;
    } else {
      entries.forEach(person => {
        let line = `${person.name}`;
        if (person.times.length > 0) {
          line += `: ${person.times.join(', ')}`;
        }
        doc.text(line, 18, y);
        y += 7;
        if (y > 278) { // Prevent writing below bottom margin
          doc.addPage();
          y = 16;
        }
      });
    }
    y += 4;
    if (y > 278) {
      doc.addPage();
      y = 16;
    }
  });

  doc.save(`floor_check_log_${new Date().toISOString().slice(0,10)}.pdf`);
}

function renderLogs() {
  const logs = getTodayLogs();
  const logList = document.getElementById('log-list');
  logList.innerHTML = `<h3>Log for Today</h3>`;

  if (logs.length === 0) {
    logList.innerHTML += '<div class="no-entries">No entries yet.</div>';
    return;
  }

  locations.forEach(loc => {
    // Filter logs for this location
    const entries = logs.filter(entry => entry.location === loc);
    logList.innerHTML += `<div class="log-entry"><strong>${loc}</strong><br>`;

    if (entries.length === 0) {
      logList.innerHTML += '<span class="timestamp">No entries</span>';
    } else {
      // Group all entries by name
      const groupedByName = {};
      entries.forEach(entry => {
        if (!groupedByName[entry.name]) {
          groupedByName[entry.name] = [];
        }
        groupedByName[entry.name].push(entry.time);
      });

      // Render grouped entries
      for (const [name, times] of Object.entries(groupedByName)) {
        logList.innerHTML += `<span>${name}: <span class="timestamp">${times.join(', ')}</span></span><br>`;
      }
    }

    logList.innerHTML += `</div>`;
  });
}


// Setup
makeButtons(cinemas, 'cinema-btns');
makeButtons(bathrooms, 'bathroom-btns');
renderLogs();
document.getElementById('export-btn').onclick = exportLogPDF;
</script>
</body>
</html>
